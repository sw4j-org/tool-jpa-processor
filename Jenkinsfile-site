pipeline {
  agent any
  stages {
    stage('Clean') {
      steps {
        deleteDir()
      }
    }
    stage('Checkout') {
      steps {
        checkout scm
      }
    }
    stage('Build') {
      steps {
        withMaven(jdk: 'Current JDK 7',
            maven: 'Current Maven 3',
            mavenLocalRepo: '${JENKINS_HOME}/maven-repositories/${EXECUTOR_NUMBER}/') {
          sh "mvn verify"
        }
      }
    }
    stage('Create Site') {
      steps {
        withMaven(jdk: 'Current JDK 7',
            maven: 'Current Maven 3',
            mavenLocalRepo: '${JENKINS_HOME}/maven-repositories/${EXECUTOR_NUMBER}/') {
          sh "mvn post-site"
          sh "mvn -f sample/pom.xml post-site"
          sh "mvn -Dscmpublish.skipCheckin=true scm-publish:publish-scm"
        }
      }
    }
    stage('Upload Site') {
      steps {
        withCredentials([string(credentialsId: "${TOKEN}", variable: 'GH_TOKEN')]) {
          sh """
            cd target/scmpublish-checkout
            git commit -a -m 'Automatic created documentation'
            git push -fq https://${GH_TOKEN}@github.com/sw4j-org/tool-jpa-processor.git gh-pages:gh-pages
          """
        }
      }
    }
  }
}
